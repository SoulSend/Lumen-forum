var w=(S,R,U)=>new Promise((B,h)=>{var s=d=>{try{p(U.next(d))}catch(b){h(b)}},q=d=>{try{p(U.throw(d))}catch(b){h(b)}},p=d=>d.done?B(d.value):Promise.resolve(d.value).then(s,q);p((U=U.apply(S,R)).next())});import{x as re,r as m,c as ue,X as Q,h as ce,H as V,I as o,aA as de,z as r,A as t,J as me,y as k,K as L,aq as ve,Q as n,O as i,ag as C,u as y,M as u,P as pe,a6 as _e,aB as fe}from"./vue-vendor-D9-fr2Es.js";import{M as ke,g as z,b as he,f as D,a as ye}from"./MainLayout-ce7fSWOU.js";import{A as M,L as be}from"./LoginPrompt-JWDjJrza.js";import{u as ge}from"./postStore-BYDGKwf5.js";import{u as we,D as Ce}from"./index-D15Qezav.js";import{a as v}from"./ui-vendor-BbrJz_TA.js";import"./utils-vendor-Cfc3znND.js";const Ue={class:"post-detail-page"},Ve={class:"container"},qe={class:"content-main"},Te={key:0,class:"post-container card"},Le={class:"post-header"},Ie={class:"post-title"},Pe={class:"post-meta"},xe={class:"author-info"},Ae=["src","alt"],De={class:"author-name"},Re={key:1,class:"author-link"},Be=["src"],Ee={class:"author-name"},Fe={class:"post-time"},Me={key:0,class:"category-tag"},Se={key:1},$e={class:"post-stats-subtle"},Ne={class:"stat-item"},He={class:"stat-item"},Oe={class:"stat-item"},Qe={class:"stat-item"},ze={class:"post-content"},Ke=["innerHTML"],Xe={key:0,class:"post-tags"},Je={class:"post-actions"},We={class:"action-buttons"},je={class:"share-options"},Ge={class:"share-link-section"},Ye={class:"share-link-container"},Ze={key:0,class:"comments-section card",id:"comments-section"},et={class:"comment-form-container",id:"comment-form"},tt={class:"comment-form-header"},st={class:"form-title"},ot={key:0,class:"replying-to"},at={class:"comment-form"},nt=re({__name:"PostDetail",setup(S){const R=de(),U=fe(),B=ge(),h=we(),s=m(null),q=m(!0),p=m(!1),d=m(0),b=m(!1),E=m(),I=m(!1),P=m(""),K=ue(()=>!s.value||!h.currentUser?!1:(s.value.userId||s.value.user_id)===h.currentUser.id),_=Q({content:"",parent_id:null}),X=Q({content:[{required:!0,message:"请输入评论内容",trigger:"blur"},{min:3,max:1e3,message:"评论长度在3到1000个字符之间",trigger:"blur"}]}),g=m(null),J=m("default"),W=m(!1),j=()=>w(null,null,function*(){q.value=!0;const a=R.params.id;try{const e=yield B.fetchPost(a);e&&(s.value=e,s.value&&(s.value.viewCount!==void 0?s.value.viewCount+=1:s.value.view_count!==void 0&&(s.value.view_count+=1)),d.value=Math.floor(Math.random()*50)+5,Z())}catch(e){console.error("Failed to fetch post:",e),v.error("获取帖子详情失败")}finally{q.value=!1}}),G=()=>w(null,null,function*(){if(!h.isAuthenticated){A("like");return}s.value&&(s.value.is_liked=!s.value.is_liked),s.value.is_liked?(s.value.likeCount!==void 0?s.value.likeCount++:s.value.like_count!==void 0&&s.value.like_count++,v.success("点赞成功")):(s.value.likeCount!==void 0?s.value.likeCount--:s.value.like_count!==void 0&&s.value.like_count--,v.info("已取消点赞"))}),Y=()=>w(null,null,function*(){if(!h.isAuthenticated){A("bookmark");return}p.value=!p.value,p.value?(d.value++,v.success("收藏成功")):(d.value--,v.info("已取消收藏"))}),Z=()=>w(null,null,function*(){!h.isAuthenticated||!s.value||(p.value=Math.random()>.7)}),ee=()=>{P.value=window.location.href,I.value=!0},F=a=>{var T;let e="";const f=encodeURIComponent(window.location.href),c=encodeURIComponent(((T=s.value)==null?void 0:T.title)||"分享文章");switch(a){case"wechat":v.success("请使用微信扫描二维码分享");break;case"weibo":e=`https://service.weibo.com/share/share.php?url=${f}&title=${c}`,window.open(e,"_blank");break;case"qq":e=`https://connect.qq.com/widget/shareqq/index.html?url=${f}&title=${c}`,window.open(e,"_blank");break}I.value=!1},$=()=>{navigator.clipboard.writeText(P.value).then(()=>{v.success("链接已复制到剪贴板")}).catch(()=>{v.error("复制失败，请手动复制")})},te=()=>{s.value&&U.push({name:"editPost",params:{id:s.value.id}})},se=()=>w(null,null,function*(){E.value&&(yield E.value.validate(a=>w(null,null,function*(){var e;if(a){b.value=!0;try{const f={content:_.content,post_id:(e=s.value)==null?void 0:e.id,parent_id:_.parent_id};v.success(g.value?"回复成功":"评论发布成功"),_.content="",N()}catch(f){console.error("Failed to submit comment:",f),v.error("评论提交失败，请稍后再试")}finally{b.value=!1}}})))}),oe=(a,e)=>{g.value={id:a,username:e},_.parent_id=a,x()},N=()=>{g.value=null,_.parent_id=null},x=()=>{setTimeout(()=>{const a=document.getElementById("comment-form");a&&a.scrollIntoView({behavior:"smooth",block:"center"})},100)},A=a=>{J.value=a,W.value=!0,(a==="like"||a==="bookmark")&&v.info("请先登录才能进行此操作"),(a==="like"||a==="bookmark")&&x()};return ce(()=>{j(),window.addEventListener("scrollToComments",a=>{const e=document.getElementById("comments-section");e&&e.scrollIntoView({behavior:"smooth",block:"start"})}),window.addEventListener("scrollToCommentForm",()=>{x()}),window.addEventListener("replyToComment",a=>{const e=a.detail;e&&e.commentId&&oe(e.commentId,e.username||"用户")})}),(a,e)=>{const f=C("router-link"),c=C("el-button"),T=C("el-input"),ae=C("el-dialog"),ne=C("el-empty"),H=C("el-form-item"),le=C("el-form"),ie=ve("loading");return r(),V(ke,null,{default:o(()=>[t("div",Ue,[t("div",Ve,[t("div",qe,[me((r(),k("div",null,[s.value?(r(),k("div",Te,[t("div",Le,[t("h1",Ie,i(s.value.title),1),t("div",Pe,[t("div",xe,[s.value.user&&s.value.user.id?(r(),V(f,{key:0,to:{name:"userProfile",params:{id:s.value.user.id}},class:"author-link"},{default:o(()=>{var l,O;return[t("img",{src:y(z)((l=s.value.user)==null?void 0:l.avatar),alt:((O=s.value.user)==null?void 0:O.username)||"用户",class:"avatar avatar--medium"},null,8,Ae),t("span",De,i(s.value.user.username),1)]}),_:1},8,["to"])):(r(),k("div",Re,[t("img",{src:y(z)(),alt:"用户",class:"avatar avatar--medium"},null,8,Be),t("span",Ee,i(y(Ce).UNKNOWN_USER),1)])),t("span",Fe,i(y(he)(s.value.createdAt||s.value.created_at)),1)]),s.value.category?(r(),k("div",Me,[s.value.category.id?(r(),V(f,{key:0,to:{name:"category",params:{id:s.value.category.id}}},{default:o(()=>[u(i(s.value.category.name),1)]),_:1},8,["to"])):(r(),k("span",Se,i(s.value.category.name||"未知分类"),1))])):L("",!0)]),t("div",$e,[t("div",Ne,[e[8]||(e[8]=t("span",{class:"material-icons-round"},"visibility",-1)),t("span",null,i(y(D)(s.value.view_count)),1)]),t("div",He,[e[9]||(e[9]=t("span",{class:"material-icons-round"},"comment",-1)),t("span",null,i(y(D)(s.value.comment_count)),1)]),t("div",Oe,[e[10]||(e[10]=t("span",{class:"material-icons-round"},"thumb_up",-1)),t("span",null,i(y(D)(s.value.like_count)),1)]),t("div",Qe,[e[11]||(e[11]=t("span",{class:"material-icons-round"},"bookmark",-1)),t("span",null,i(y(D)(d.value)),1)])])]),t("div",ze,[t("div",{class:"content-html",innerHTML:s.value.content},null,8,Ke),s.value.tags&&s.value.tags.length>0?(r(),k("div",Xe,[e[12]||(e[12]=t("span",{class:"tag-label"},"标签：",-1)),(r(!0),k(pe,null,_e(s.value.tags,l=>(r(),V(f,{key:l.id,to:{name:"search",query:{tag_id:l.id}},class:"tag"},{default:o(()=>[u(i(l.name),1)]),_:2},1032,["to"]))),128))])):L("",!0)]),t("div",Je,[t("div",We,[K.value?(r(),V(c,{key:0,onClick:te,type:"primary",class:"action-button edit-button"},{default:o(()=>e[13]||(e[13]=[t("span",{class:"material-icons-round"},"edit",-1),u(" 编辑帖子 ")])),_:1,__:[13]})):L("",!0),n(M,{level:"user",type:"level"},{fallback:o(()=>[n(c,{onClick:e[0]||(e[0]=l=>A("like")),class:"action-button"},{default:o(()=>[e[15]||(e[15]=t("span",{class:"material-icons-round"},"thumb_up",-1)),u(" "+i(s.value.like_count)+" 点赞 ",1)]),_:1,__:[15]})]),default:o(()=>[n(c,{onClick:G,type:s.value.is_liked?"primary":"",class:"action-button"},{default:o(()=>[e[14]||(e[14]=t("span",{class:"material-icons-round"},"thumb_up",-1)),u(" "+i(s.value.like_count)+" 点赞 ",1)]),_:1,__:[14]},8,["type"])]),_:1}),n(M,{level:"user",type:"level"},{fallback:o(()=>[n(c,{onClick:e[1]||(e[1]=l=>A("bookmark")),class:"action-button"},{default:o(()=>e[17]||(e[17]=[t("span",{class:"material-icons-round"},"bookmark",-1),u(" 收藏 ")])),_:1,__:[17]})]),default:o(()=>[n(c,{onClick:Y,type:p.value?"primary":"",class:"action-button"},{default:o(()=>[e[16]||(e[16]=t("span",{class:"material-icons-round"},"bookmark",-1)),u(" "+i(p.value?"已收藏":"收藏"),1)]),_:1,__:[16]},8,["type"])]),_:1}),n(c,{onClick:ee,class:"action-button"},{default:o(()=>e[18]||(e[18]=[t("span",{class:"material-icons-round"},"share",-1),u(" 分享 ")])),_:1,__:[18]}),n(c,{onClick:x,class:"action-button"},{default:o(()=>e[19]||(e[19]=[t("span",{class:"material-icons-round"},"edit",-1),u(" 评论 ")])),_:1,__:[19]})])]),n(ae,{modelValue:I.value,"onUpdate:modelValue":e[6]||(e[6]=l=>I.value=l),title:"分享文章",width:"360px","show-close":!0,center:""},{default:o(()=>[t("div",je,[t("div",{class:"share-option",onClick:e[2]||(e[2]=l=>F("wechat"))},e[20]||(e[20]=[t("div",{class:"share-icon wechat-icon"},[t("i",{class:"icon-wechat"})],-1),t("div",{class:"share-name"},"微信",-1)])),t("div",{class:"share-option",onClick:e[3]||(e[3]=l=>F("weibo"))},e[21]||(e[21]=[t("div",{class:"share-icon weibo-icon"},[t("i",{class:"icon-weibo"})],-1),t("div",{class:"share-name"},"微博",-1)])),t("div",{class:"share-option",onClick:e[4]||(e[4]=l=>F("qq"))},e[22]||(e[22]=[t("div",{class:"share-icon qq-icon"},[t("i",{class:"icon-qq"})],-1),t("div",{class:"share-name"},"QQ",-1)])),t("div",{class:"share-option",onClick:$},e[23]||(e[23]=[t("div",{class:"share-icon link-icon"},[t("i",{class:"icon-link"})],-1),t("div",{class:"share-name"},"复制链接",-1)]))]),t("div",Ge,[t("div",Ye,[n(T,{modelValue:P.value,"onUpdate:modelValue":e[5]||(e[5]=l=>P.value=l),readonly:""},null,8,["modelValue"]),n(c,{type:"primary",onClick:$},{default:o(()=>e[24]||(e[24]=[u("复制")])),_:1,__:[24]})])])]),_:1},8,["modelValue"])])):(r(),V(ne,{key:1,description:"帖子不存在或已被删除"}))])),[[ie,q.value]]),s.value?(r(),k("div",Ze,[e[26]||(e[26]=t("div",{class:"comments-header"},[t("h2",{class:"section-title"},"评论区")],-1)),t("div",et,[t("div",tt,[t("h3",st,[u(i(g.value?"回复评论":"发表评论")+" ",1),g.value?(r(),k("span",ot,[u(" 回复给："+i(g.value.username)+" ",1),n(c,{link:"",onClick:N,class:"cancel-reply"},{default:o(()=>e[25]||(e[25]=[t("i",{class:"icon-close"},null,-1),u(" 取消回复 ")])),_:1,__:[25]})])):L("",!0)])]),n(M,{level:"user",type:"level"},{fallback:o(()=>[n(be,{type:"comment"})]),default:o(()=>[t("div",at,[n(le,{model:_,rules:X,ref_key:"commentFormRef",ref:E},{default:o(()=>[n(H,{prop:"content"},{default:o(()=>[n(T,{modelValue:_.content,"onUpdate:modelValue":e[7]||(e[7]=l=>_.content=l),type:"textarea",rows:4,placeholder:"请输入您的评论内容...",resize:"none",maxlength:"1000","show-word-limit":""},null,8,["modelValue"])]),_:1}),n(H,{class:"form-actions"},{default:o(()=>[n(c,{type:"primary",loading:b.value,onClick:se,disabled:!_.content.trim()},{default:o(()=>[u(i(g.value?"提交回复":"发表评论"),1)]),_:1},8,["loading","disabled"])]),_:1})]),_:1},8,["model","rules"])])]),_:1})])])):L("",!0)])])])]),_:1})}}}),pt=ye(nt,[["__scopeId","data-v-fe8c58ce"]]);export{pt as default};

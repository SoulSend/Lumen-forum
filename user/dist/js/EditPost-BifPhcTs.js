var v=(M,p,_)=>new Promise((V,w)=>{var C=d=>{try{g(_.next(d))}catch(c){w(c)}},l=d=>{try{g(_.throw(d))}catch(c){w(c)}},g=d=>d.done?V(d.value):Promise.resolve(d.value).then(C,l);g((_=_.apply(M,p)).next())});import{x as X,r as y,X as j,h as G,H as E,I as i,aA as W,z as u,aB as Y,ag as m,aq as Z,J as ee,y as h,A as k,K as te,Q as s,V as oe,P as U,a6 as q,u as F,M as S}from"./vue-vendor-D9-fr2Es.js";import{u as ae,M as se,a as le}from"./MainLayout-ce7fSWOU.js";import{u as ne}from"./postStore-BYDGKwf5.js";import{u as re}from"./index-D15Qezav.js";import{Q as ie}from"./editor-vendor-C_CoOyx-.js";/* empty css                       */import{a as b,d as de}from"./ui-vendor-BbrJz_TA.js";import"./utils-vendor-Cfc3znND.js";const ue={class:"edit-post-page"},ce={key:0,class:"post-form-container"},me={class:"editor-container"},pe={class:"form-actions"},_e={key:1,class:"not-found"},ge={class:"back-button"},fe=X({__name:"EditPost",setup(M){const p=Y(),_=W(),V=ne(),w=ae(),C=re(),l=y(null),g=y(),d=y(!0),c=y(!1),P=y([]),T=y([]),D={placeholder:"请输入帖子内容...",modules:{toolbar:"#toolbar"}},R=[["bold","italic","underline","strike"],[{header:1},{header:2}],[{list:"ordered"},{list:"bullet"}],[{indent:"-1"},{indent:"+1"}],[{direction:"rtl"}],[{size:["small",!1,"large","huge"]}],[{header:[1,2,3,4,5,6,!1]}],[{color:[]},{background:[]}],[{align:[]}],["link","image","code-block"],["clean"]],A=o=>{},L=(o,e,n)=>{},t=j({title:"",content:"",category_id:null,tags:[]}),N={title:[{required:!0,message:"请输入帖子标题",trigger:"blur"},{min:5,max:100,message:"标题长度应在5-100个字符之间",trigger:"blur"}],category_id:[{required:!0,message:"请选择分类",trigger:"change"}],content:[{required:!0,message:"请输入帖子内容",trigger:"blur"},{min:10,message:"内容长度不能少于10个字符",trigger:"blur"}]},I=()=>v(null,null,function*(){const o=_.params.id;try{const e=yield V.fetchPost(o);if(e){l.value=e;const n=C.currentUser;if(!n||n.id!==e.user_id&&!n.is_admin&&!n.is_moderator){l.value=null,b.error("您没有权限编辑此帖子");return}t.title=e.title,t.content=e.content,t.category_id=e.category_id,t.tags=e.tags.map(r=>r.id),document.title=`编辑: ${e.title} - Lumen论坛`}}catch(e){console.error("Failed to fetch post:",e),b.error("获取帖子信息失败")}finally{d.value=!1}}),Q=()=>v(null,null,function*(){try{const o=yield w.fetchCategories();o&&(P.value=o)}catch(o){console.error("Failed to fetch categories:",o),b.error("获取分类列表失败")}}),z=()=>v(null,null,function*(){!g.value||!l.value||(yield g.value.validate(o=>v(null,null,function*(){if(o){c.value=!0;try{(yield V.updatePost(l.value.id,{title:t.title,content:t.content,category_id:t.category_id,tags:t.tags}))?(b({message:"帖子更新成功！即将返回帖子详情页",type:"success",duration:2e3}),setTimeout(()=>{p.push({name:"postDetail",params:{id:l.value.id}})},1500)):b.error("帖子更新失败，请稍后再试")}catch(e){console.error("Failed to update post:",e),b.error("帖子更新失败，请稍后再试")}finally{c.value=!1}}})))}),O=()=>{var o,e,n,r;t.title!==((o=l.value)==null?void 0:o.title)||t.content!==((e=l.value)==null?void 0:e.content)||t.category_id!==((n=l.value)==null?void 0:n.category_id)||!$(t.tags,((r=l.value)==null?void 0:r.tags.map(f=>f.id))||[])?de.confirm("您有未保存的修改，确定要离开吗？","确认离开",{confirmButtonText:"确认离开",cancelButtonText:"继续编辑",type:"warning"}).then(()=>{p.back()}).catch(()=>{}):p.back()},$=(o,e)=>{if(o.length!==e.length)return!1;const n=[...o].sort(),r=[...e].sort();return n.every((f,x)=>f===r[x])};return G(()=>v(null,null,function*(){yield Q(),T.value=[{id:1,name:"生活技巧",description:"",slug:"",post_count:0,created_at:"",updated_at:""},{id:2,name:"家居",description:"",slug:"",post_count:0,created_at:"",updated_at:""},{id:3,name:"美食",description:"",slug:"",post_count:0,created_at:"",updated_at:""},{id:4,name:"旅行",description:"",slug:"",post_count:0,created_at:"",updated_at:""},{id:5,name:"健康",description:"",slug:"",post_count:0,created_at:"",updated_at:""}],yield I()})),(o,e)=>{const n=m("el-input"),r=m("el-form-item"),f=m("el-option"),x=m("el-select"),B=m("el-button"),H=m("el-form"),J=m("el-empty"),K=Z("loading");return u(),E(se,null,{default:i(()=>[ee((u(),h("div",ue,[e[8]||(e[8]=k("div",{class:"page-header"},[k("h1",{class:"page-title"},"编辑帖子")],-1)),l.value?(u(),h("div",ce,[s(H,{ref:"postForm",model:t,rules:N,"label-position":"top",onSubmit:oe(z,["prevent"])},{default:i(()=>[s(r,{label:"标题",prop:"title"},{default:i(()=>[s(n,{modelValue:t.title,"onUpdate:modelValue":e[0]||(e[0]=a=>t.title=a),placeholder:"请输入帖子标题",maxlength:"100","show-word-limit":""},null,8,["modelValue"])]),_:1}),s(r,{label:"分类",prop:"category_id"},{default:i(()=>[s(x,{modelValue:t.category_id,"onUpdate:modelValue":e[1]||(e[1]=a=>t.category_id=a),placeholder:"请选择分类",class:"category-select"},{default:i(()=>[(u(!0),h(U,null,q(P.value,a=>(u(),E(f,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),s(r,{label:"内容",prop:"content"},{default:i(()=>[k("div",me,[s(F(ie),{content:t.content,"onUpdate:content":e[2]||(e[2]=a=>t.content=a),contentType:"html",options:D,toolbar:R,theme:"snow",onReady:A,onTextChange:L},null,8,["content"])])]),_:1}),s(r,{label:"标签"},{default:i(()=>[s(x,{modelValue:t.tags,"onUpdate:modelValue":e[3]||(e[3]=a=>t.tags=a),multiple:"",placeholder:"选择标签（可选）",class:"tag-select"},{default:i(()=>[(u(!0),h(U,null,q(T.value,a=>(u(),E(f,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),s(r,null,{default:i(()=>[k("div",pe,[s(B,{onClick:O},{default:i(()=>e[5]||(e[5]=[S("取消")])),_:1,__:[5]}),s(B,{type:"primary","native-type":"submit",loading:c.value},{default:i(()=>e[6]||(e[6]=[S("保存修改")])),_:1,__:[6]},8,["loading"])])]),_:1})]),_:1},8,["model"])])):d.value?te("",!0):(u(),h("div",_e,[s(J,{description:"帖子不存在或您没有编辑权限"}),k("div",ge,[s(B,{onClick:e[4]||(e[4]=a=>F(p).push("/"))},{default:i(()=>e[7]||(e[7]=[S("返回首页")])),_:1,__:[7]})])]))])),[[K,d.value]])]),_:1})}}}),Be=le(fe,[["__scopeId","data-v-b764a6ca"]]);export{Be as default};

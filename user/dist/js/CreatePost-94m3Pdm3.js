var b=(N,v,h)=>new Promise((q,B)=>{var x=m=>{try{k(h.next(m))}catch(y){B(y)}},w=m=>{try{k(h.throw(m))}catch(y){B(y)}},k=m=>m.done?q(m.value):Promise.resolve(m.value).then(x,w);k((h=h.apply(N,v)).next())});import{x as me,r as _,X as pe,c as fe,h as _e,aA as ge,W as ve,H as R,I as l,z as p,Q as o,A as t,C as ye,D as U,ag as f,V as be,M as g,u as d,y as V,a6 as O,P as j,K as L,O as he,T as J,J as we,R as ke,aB as Ve}from"./vue-vendor-D9-fr2Es.js";import{a as u,d as Q,e as xe,f as G,p as Se,h as Ce,j as Ue,s as Be,k as Te,l as Ie,m as Re,n as qe}from"./ui-vendor-BbrJz_TA.js";import{u as De,M as Ee,a as Fe}from"./MainLayout-ce7fSWOU.js";import{u as Me}from"./postStore-BYDGKwf5.js";import{Q as Le}from"./editor-vendor-C_CoOyx-.js";/* empty css                       */import{L as Ne,A as Pe}from"./LoginPrompt-JWDjJrza.js";import"./index-D15Qezav.js";import"./utils-vendor-Cfc3znND.js";const ze={class:"create-post-page"},Ae={class:"post-form-container"},Oe={class:"form-progress"},je={class:"progress-steps"},Je={class:"form-section"},Qe={class:"section-header"},Ge={class:"section-title"},He={class:"form-row"},We={class:"form-section"},$e={class:"section-header"},Ke={class:"section-title"},Xe={key:0,class:"cover-preview"},Ye=["src"],Ze={class:"cover-overlay"},et={key:1,class:"upload-placeholder"},tt={class:"form-section"},st={class:"section-header"},ot={class:"section-title"},at={class:"editor-container"},lt={class:"form-section"},it={class:"section-header"},nt={class:"section-title"},rt={class:"settings-options"},ct={class:"setting-item"},dt={class:"setting-item"},ut={class:"setting-item"},mt={class:"form-actions-container"},pt={class:"form-actions"},ft={class:"action-left"},_t={key:0,class:"draft-hint"},gt={class:"action-right"},vt={class:"posting-guidelines"},yt={key:0,class:"save-notification"},bt=me({__name:"CreatePost",setup(N){const v=Ve(),h=ge(),q=Me(),B=De(),x=_(),w=_(!1),k=_([]),m=_([]),y=_(null),P=[["bold","italic","underline","strike"],["blockquote","code-block"],[{header:1},{header:2}],[{list:"ordered"},{list:"bullet"}],[{script:"sub"},{script:"super"}],[{indent:"-1"},{indent:"+1"}],[{direction:"rtl"}],[{size:["small",!1,"large","huge"]}],[{header:[1,2,3,4,5,6,!1]}],[{color:[]},{background:[]}],[{font:[]}],[{align:[]}],["clean"],["link","image","video"]],H={placeholder:"请输入帖子内容...",modules:{toolbar:{container:P,handlers:{image:W}}}};function W(){const a=this,e=document.createElement("input");e.setAttribute("type","file"),e.setAttribute("accept","image/*"),e.click(),e.onchange=()=>b(this,null,function*(){var c;if((c=e.files)==null?void 0:c[0])try{u({message:"图片上传中...",type:"info",duration:0,showClose:!0}),yield new Promise(I=>setTimeout(I,1e3));const r="https://picsum.photos/800/600?random="+Math.random();u.closeAll();const C=a.quill.getSelection(!0);a.quill.insertEmbed(C.index,"image",r),a.quill.setSelection(C.index+1),u.success("图片上传成功")}catch(r){console.error("Failed to upload image:",r),u.error("图片上传失败")}})}const $=a=>{},K=(a,e,i)=>{},X=(a,e,i)=>{},Y=()=>{},Z=()=>{},s=pe({title:"",content:"",category_id:null,tags:[],cover_image:"",allow_comments:!0,is_original:!0,notify_followers:!1,save_draft:!1}),S=fe(()=>{let a=0;if(s.title.trim().length>0&&(a+=12.5),s.category_id!==null&&(a+=12.5),s.content.trim().length>0){const e=s.content.trim().length;e>20&&(a+=25),e>100&&(a+=25)}return a>=75&&(a=100),a}),T=_(!0),ee=()=>{T.value=!T.value},D=_(!1),E=_(null),te=()=>{D.value=!0,E.value!==null&&clearTimeout(E.value),E.value=window.setTimeout(()=>{D.value=!1},3e3)},se={title:[{required:!0,message:"请输入帖子标题",trigger:"blur"},{min:5,max:100,message:"标题长度应在5-100个字符之间",trigger:"blur"}],category_id:[{required:!0,message:"请选择分类",trigger:"change"}],content:[{required:!0,message:"请输入帖子内容",trigger:"blur"},{min:20,message:"内容长度不能少于20个字符",trigger:"blur"}]},oe=a=>{const e=a.type.startsWith("image/"),i=a.size/1024/1024<2;return e?i?!0:(u.error("上传封面图片大小不能超过 2MB!"),!1):(u.error("上传封面只能是图片格式!"),!1)},ae=(a,e)=>{s.cover_image=URL.createObjectURL(e.raw)},le=()=>b(null,null,function*(){try{const a=yield B.fetchCategories();a&&(k.value=a)}catch(a){console.error("Failed to fetch categories:",a),u.error("获取分类列表失败")}}),z=()=>b(null,null,function*(){if(!(!s.title.trim()&&!s.content.trim()))try{localStorage.setItem("post_draft",JSON.stringify({title:s.title,content:s.content,category_id:s.category_id,tags:s.tags,cover_image:s.cover_image,timestamp:Date.now()})),te()}catch(a){console.error("Failed to save draft:",a)}}),ie=()=>{try{const a=localStorage.getItem("post_draft");if(a){const e=JSON.parse(a),i=Date.now(),c=e.timestamp||0;i-c<24*60*60*1e3&&Q.confirm("发现您有未完成的草稿，是否继续编辑？","加载草稿",{confirmButtonText:"继续编辑",cancelButtonText:"丢弃",type:"info"}).then(()=>{s.title=e.title||"",s.content=e.content||"",s.category_id=e.category_id,s.tags=e.tags||[],s.cover_image=e.cover_image||"",u.success("已加载草稿")}).catch(()=>{localStorage.removeItem("post_draft"),u.info("已丢弃草稿")})}}catch(a){console.error("Failed to load draft:",a)}},ne=()=>b(null,null,function*(){x.value&&(yield x.value.validate(a=>b(null,null,function*(){var e;if(a){w.value=!0;try{const i=yield q.createPost({title:s.title,content:s.content,category_id:s.category_id,tags:s.tags.length>0?s.tags:void 0,cover_image:s.cover_image,allow_comments:s.allow_comments,is_original:s.is_original,is_draft:s.save_draft,notify_followers:s.notify_followers});if(i){localStorage.removeItem("post_draft");const c=s.save_draft?"草稿保存成功！":"帖子发布成功！";if(u.success(c),s.save_draft){const r=(e=userStore.currentUser)==null?void 0:e.id;r?v.push({name:"userProfile",params:{id:r},query:{tab:"drafts"}}):v.push({name:"home"})}else v.push({name:"postDetail",params:{id:i.id}})}else{const c=s.save_draft?"保存草稿":"发布帖子";u.error(`${c}失败，请稍后再试`)}}catch(i){console.error("Failed to create post:",i);const c=s.save_draft?"保存草稿":"发布帖子";u.error(`${c}失败，请稍后再试`)}finally{w.value=!1}}})))}),re=()=>{s.title||s.content?Q.confirm("离开页面将丢失未保存的内容，是否继续？","确认离开",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(()=>{v.back()}).catch(()=>{}):v.back()},A=a=>{(s.title||s.content)&&(z(),a.preventDefault(),a.returnValue="")};return _e(()=>b(null,null,function*(){yield le();const a=h.query.category_id;a&&(s.category_id=Number(a)),ie(),y.value=window.setInterval(z,6e4),window.addEventListener("beforeunload",A),m.value=[{id:1,name:"生活技巧",description:"",slug:"",post_count:0,created_at:"",updated_at:""},{id:2,name:"家居",description:"",slug:"",post_count:0,created_at:"",updated_at:""},{id:3,name:"美食",description:"",slug:"",post_count:0,created_at:"",updated_at:""},{id:4,name:"旅行",description:"",slug:"",post_count:0,created_at:"",updated_at:""},{id:5,name:"健康",description:"",slug:"",post_count:0,created_at:"",updated_at:""}]})),ve(()=>{y.value!==null&&clearInterval(y.value),window.removeEventListener("beforeunload",A)}),(a,e)=>{const i=f("el-icon"),c=f("el-input"),r=f("el-form-item"),C=f("el-option"),I=f("el-select"),F=f("el-button"),ce=f("el-upload"),M=f("el-switch"),de=f("el-checkbox"),ue=f("el-form");return p(),R(Ee,null,{default:l(()=>[o(Pe,{level:"user",type:"level","custom-message":"您需要登录才能发布帖子"},{fallback:l(()=>[o(Ne,{type:"create"})]),default:l(()=>[t("div",ze,[e[28]||(e[28]=t("div",{class:"page-header"},[t("h1",{class:"page-title"},"发布帖子"),t("p",{class:"page-description"},"分享您的观点、问题或创意与社区一起讨论")],-1)),t("div",Ae,[t("div",Oe,[t("div",{class:"progress-bar",style:ye({width:S.value+"%"})},null,4),t("div",je,[t("div",{class:U(["progress-step",{active:S.value>=25}])},e[8]||(e[8]=[t("div",{class:"step-icon"},"1",-1),t("div",{class:"step-label"},"基本信息",-1)]),2),t("div",{class:U(["progress-step",{active:S.value>=50}])},e[9]||(e[9]=[t("div",{class:"step-icon"},"2",-1),t("div",{class:"step-label"},"内容编辑",-1)]),2),t("div",{class:U(["progress-step",{active:S.value>=75}])},e[10]||(e[10]=[t("div",{class:"step-icon"},"3",-1),t("div",{class:"step-label"},"发布设置",-1)]),2),t("div",{class:U(["progress-step",{active:S.value>=100}])},e[11]||(e[11]=[t("div",{class:"step-icon"},"4",-1),t("div",{class:"step-label"},"完成发布",-1)]),2)])]),o(ue,{ref_key:"postFormRef",ref:x,model:s,rules:se,"label-position":"top",onSubmit:be(ne,["prevent"])},{default:l(()=>[t("div",Je,[t("div",Qe,[t("h2",Ge,[o(i,null,{default:l(()=>[o(d(xe))]),_:1}),e[12]||(e[12]=g(" 基本信息 "))]),e[13]||(e[13]=t("p",{class:"section-description"},"设置帖子的标题、分类和标签",-1))]),o(r,{label:"标题",prop:"title"},{default:l(()=>[o(c,{modelValue:s.title,"onUpdate:modelValue":e[0]||(e[0]=n=>s.title=n),placeholder:"请输入一个吸引人的标题",maxlength:"100","show-word-limit":"",class:"title-input"},{prefix:l(()=>[o(i,null,{default:l(()=>[o(d(G))]),_:1})]),_:1},8,["modelValue"])]),_:1}),t("div",He,[o(r,{label:"分类",prop:"category_id",class:"category-form-item"},{default:l(()=>[o(I,{modelValue:s.category_id,"onUpdate:modelValue":e[1]||(e[1]=n=>s.category_id=n),placeholder:"请选择分类",class:"category-select"},{default:l(()=>[(p(!0),V(j,null,O(k.value,n=>(p(),R(C,{key:n.id,label:n.name,value:n.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),o(r,{label:"标签",class:"tags-form-item"},{default:l(()=>[o(I,{modelValue:s.tags,"onUpdate:modelValue":e[2]||(e[2]=n=>s.tags=n),multiple:"",filterable:"","allow-create":"","default-first-option":"",placeholder:"选择或创建标签",class:"tag-select"},{default:l(()=>[(p(!0),V(j,null,O(m.value,n=>(p(),R(C,{key:n.id,label:n.name,value:n.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})])]),t("div",We,[t("div",$e,[t("h2",Ke,[o(i,null,{default:l(()=>[o(d(Se))]),_:1}),e[14]||(e[14]=g(" 封面图片 "))]),e[15]||(e[15]=t("p",{class:"section-description"},"上传一张吸引人的封面图片（可选）",-1))]),o(r,null,{default:l(()=>[o(ce,{class:"cover-uploader",action:"/api/upload","show-file-list":!1,"on-success":ae,"before-upload":oe,accept:"image/jpeg,image/png,image/gif"},{default:l(()=>[s.cover_image?(p(),V("div",Xe,[t("img",{src:s.cover_image,class:"cover-image"},null,8,Ye),t("div",Ze,[o(F,{type:"primary",circle:""},{default:l(()=>[o(i,null,{default:l(()=>[o(d(G))]),_:1})]),_:1})])])):(p(),V("div",et,[o(i,{class:"cover-uploader-icon"},{default:l(()=>[o(d(Ce))]),_:1}),e[16]||(e[16]=t("div",{class:"el-upload__tip"},[g(" 点击上传封面图片"),t("br"),t("span",{class:"upload-tip-sub"},"建议尺寸 1200x400 像素")],-1))]))]),_:1})]),_:1})]),t("div",tt,[t("div",st,[t("h2",ot,[o(i,null,{default:l(()=>[o(d(Ue))]),_:1}),e[17]||(e[17]=g(" 内容编辑 "))]),e[18]||(e[18]=t("p",{class:"section-description"},"使用富文本编辑器编写帖子内容",-1))]),o(r,{label:"内容",prop:"content"},{default:l(()=>[t("div",at,[o(d(Le),{content:s.content,"onUpdate:content":e[3]||(e[3]=n=>s.content=n),contentType:"html",options:H,toolbar:P,theme:"snow",onReady:$,onTextChange:K,onSelectionChange:X,onFocus:Y,onBlur:Z},null,8,["content"])])]),_:1})]),t("div",lt,[t("div",it,[t("h2",nt,[o(i,null,{default:l(()=>[o(d(Be))]),_:1}),e[19]||(e[19]=g(" 发布设置 "))]),e[20]||(e[20]=t("p",{class:"section-description"},"设置帖子的发布选项",-1))]),t("div",rt,[t("div",ct,[o(M,{modelValue:s.allow_comments,"onUpdate:modelValue":e[4]||(e[4]=n=>s.allow_comments=n),"active-text":"允许评论","inactive-text":"禁止评论"},null,8,["modelValue"]),e[21]||(e[21]=t("div",{class:"setting-description"},"允许其他用户在您的帖子下发表评论",-1))]),t("div",dt,[o(M,{modelValue:s.is_original,"onUpdate:modelValue":e[5]||(e[5]=n=>s.is_original=n),"active-text":"原创内容","inactive-text":"转载内容"},null,8,["modelValue"]),e[22]||(e[22]=t("div",{class:"setting-description"},"标记为您的原创内容，获得更多曝光",-1))]),t("div",ut,[o(M,{modelValue:s.notify_followers,"onUpdate:modelValue":e[6]||(e[6]=n=>s.notify_followers=n),"active-text":"通知关注者","inactive-text":"不通知"},null,8,["modelValue"]),e[23]||(e[23]=t("div",{class:"setting-description"},"发布后通知您的关注者",-1))])])]),t("div",mt,[t("div",pt,[t("div",ft,[o(de,{modelValue:s.save_draft,"onUpdate:modelValue":e[7]||(e[7]=n=>s.save_draft=n)},{default:l(()=>e[24]||(e[24]=[g("保存为草稿")])),_:1,__:[24]},8,["modelValue"]),s.save_draft?(p(),V("span",_t,"草稿将保存在您的个人中心")):L("",!0)]),t("div",gt,[o(F,{onClick:re,class:"cancel-btn",size:"large"},{default:l(()=>[o(i,null,{default:l(()=>[o(d(Te))]),_:1}),e[25]||(e[25]=g(" 取消 "))]),_:1,__:[25]}),o(F,{type:"primary","native-type":"submit",loading:w.value,class:"submit-btn",size:"large"},{default:l(()=>[w.value?L("",!0):(p(),R(i,{key:0},{default:l(()=>[o(d(Ie))]),_:1})),t("span",null,he(s.save_draft?"保存草稿":"发布帖子"),1)]),_:1},8,["loading"])])])]),t("div",vt,[t("div",{class:"guidelines-header",onClick:ee},[e[26]||(e[26]=t("h4",null,"发帖须知",-1)),o(i,{class:U({rotate:T.value})},{default:l(()=>[o(d(Re))]),_:1},8,["class"])]),o(J,{name:"fade"},{default:l(()=>[we(t("ul",null,e[27]||(e[27]=[t("li",null,"请确保帖子内容符合社区规范",-1),t("li",null,"尊重版权，引用他人内容请注明出处",-1),t("li",null,"帖子发布后可以编辑，但有24小时时间限制",-1),t("li",null,"高质量的内容更容易获得推荐",-1)]),512),[[ke,T.value]])]),_:1})])]),_:1},8,["model"])])])]),_:1}),o(J,{name:"fade"},{default:l(()=>[D.value?(p(),V("div",yt,[o(i,null,{default:l(()=>[o(d(qe))]),_:1}),e[29]||(e[29]=g(" 草稿已自动保存 "))])):L("",!0)]),_:1})]),_:1})}}}),It=Fe(bt,[["__scopeId","data-v-9cb85135"]]);export{It as default};
